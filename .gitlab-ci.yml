stages:
  - build
  - test
  - deploy

# Build job
Build:
  stage: build
  before_script:
    - "versioner -o ./SpotifyWebApi/SpotifyWebApi.csproj -c"
  script:
    - "dotnet build -c Release"
    - "dotnet pack -c Release -o ../Publish --no-build --include-symbols --include-source ./SpotifyWebApi/SpotifyWebApi.csproj"
  artifacts:
    untracked: true

# Integration tests
Test:
  stage: test
  dependencies:
    - Build
#  artifacts:
#    paths:
#     - "Web.IntegrationTests/TestResults/"
#    reports:
#      junit: "Web.IntegrationTests/TestResults/testResults.xml"
  script:
    - "dotnet test Test -c Release --no-build"

# Coverage
.Coverage:
  stage: test
  dependencies:
    - Build
  artifacts:
    paths:
     - "coverage.json"
  script:
    - "coverlet Test/bin/Release/netcoreapp2.0/SpotifyWebApiTest.dll --target 'dotnet' --targetargs 'test Test -c Release --no-build'"

Deploy:
  stage: deploy
  dependencies:
    - Build
    - Test
  script:
    - "dotnet nuget push Publish/**/*.nupkg -s https://api.nuget.org/v3/index.json -k %NUGET_API_KEY%"
  artifacts:
    paths:
    - "./Publish"
    name: Nuget package
  only:
   - "master"
   - "tags"